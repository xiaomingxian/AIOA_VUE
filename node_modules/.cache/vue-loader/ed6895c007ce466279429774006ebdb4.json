{"remainingRequest":"D:\\ProgramFiles\\ideaIUWork\\jeecg-boot\\ant-design-vue-jeecg\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\ProgramFiles\\ideaIUWork\\jeecg-boot\\ant-design-vue-jeecg\\src\\components\\tools\\HeaderNotice.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\ProgramFiles\\ideaIUWork\\jeecg-boot\\ant-design-vue-jeecg\\src\\components\\tools\\HeaderNotice.vue","mtime":1568535215786},{"path":"D:\\ProgramFiles\\ideaIUWork\\jeecg-boot\\ant-design-vue-jeecg\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1568345883562},{"path":"D:\\ProgramFiles\\ideaIUWork\\jeecg-boot\\ant-design-vue-jeecg\\node_modules\\babel-loader\\lib\\index.js","mtime":1568345858740},{"path":"D:\\ProgramFiles\\ideaIUWork\\jeecg-boot\\ant-design-vue-jeecg\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1568345883562},{"path":"D:\\ProgramFiles\\ideaIUWork\\jeecg-boot\\ant-design-vue-jeecg\\node_modules\\vue-loader\\lib\\index.js","mtime":1568345696677}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { getAction,putAction } from '@/api/manage'\nimport ShowAnnouncement from './ShowAnnouncement'\nimport store from '@/store/'\n\nexport default {\n  name: \"HeaderNotice\",\n  components: {\n    ShowAnnouncement,\n  },\n  data () {\n    return {\n      loadding: false,\n      url:{\n        listCementByUser:\"/sys/annountCement/listByUser\",\n        editCementSend:\"/sys/sysAnnouncementSend/editByAnntIdAndUserId\",\n        queryById:\"/sys/annountCement/queryById\",\n      },\n      hovered: false,\n      announcement1:[],\n      announcement2:[],\n      msg1Count:\"3\",\n      msg2Count:\"0\",\n      msg1Title:\"通知(3)\",\n      msg2Title:\"\",\n      stopTimer:false,\n    }\n  },\n  computed:{\n    msgTotal () {\n      return parseInt(this.msg1Count)+parseInt(this.msg2Count);\n    }\n  },\n  mounted() {\n    this.loadData();\n    //this.timerFun();\n    this.initWebSocket();\n  },\n  destroyed: function () { // 离开页面生命周期函数\n    this.websocketclose();\n  },\n  methods: {\n    timerFun() {\n      this.stopTimer = false;\n      let myTimer = setInterval(()=>{\n        // 停止定时器\n        if (this.stopTimer == true) {\n          clearInterval(myTimer);\n          return;\n        }\n        this.loadData()\n      },6000)\n    },\n    loadData (){\n      try {\n        // 获取系统消息\n        getAction(this.url.listCementByUser).then((res) => {\n          if (res.success) {\n            this.announcement1 = res.result.anntMsgList;\n            this.msg1Count = res.result.anntMsgTotal;\n            this.msg1Title = \"通知(\" + res.result.anntMsgTotal + \")\";\n            this.announcement2 = res.result.sysMsgList;\n            this.msg2Count = res.result.sysMsgTotal;\n            this.msg2Title = \"系统消息(\" + res.result.sysMsgTotal + \")\";\n          }\n        }).catch(error => {\n          console.log(\"系统消息通知异常\",error);//这行打印permissionName is undefined\n          this.stopTimer = true;\n          console.log(\"清理timer\");\n        });\n      } catch (err) {\n        this.stopTimer = true;\n        console.log(\"通知异常\",err);\n      }\n    },\n    fetchNotice () {\n      if (this.loadding) {\n        this.loadding = false\n        return\n      }\n      this.loadding = true\n      setTimeout(() => {\n        this.loadding = false\n      }, 200)\n    },\n    showAnnouncement(record){\n      putAction(this.url.editCementSend,{anntId:record.id}).then((res)=>{\n        if(res.success){\n          this.loadData();\n        }\n      });\n      this.hovered = false;\n      this.$refs.ShowAnnouncement.detail(record);\n    },\n    toMyAnnouncement(){\n\n      this.$router.push({\n        path: '/isps/userAnnouncement',\n        name: 'isps-userAnnouncement'\n      });\n    },\n    modalFormOk(){\n    },\n    handleHoverChange (visible) {\n      this.hovered = visible;\n    },\n\n    initWebSocket: function () {\n      // WebSocket与普通的请求所用协议有所不同，ws等同于http，wss等同于https\n      var userId = store.getters.userInfo.id;\n      var url = window._CONFIG['domianURL'].replace(\"https://\",\"wss://\").replace(\"http://\",\"ws://\")+\"/websocket/\"+userId;\n      //console.log(url);\n      this.websock = new WebSocket(url);\n      this.websock.onopen = this.websocketonopen;\n      this.websock.onerror = this.websocketonerror;\n      this.websock.onmessage = this.websocketonmessage;\n      this.websock.onclose = this.websocketclose;\n    },\n    websocketonopen: function () {\n      console.log(\"WebSocket连接成功\");\n    },\n    websocketonerror: function (e) {\n      console.log(\"WebSocket连接发生错误\");\n    },\n    websocketonmessage: function (e) {\n      console.log(\"-----接收消息-------\",e.data);\n      var data = eval(\"(\" + e.data + \")\"); //解析对象\n      this.loadData();\n      //if(data.cmd == \"topic\"){\n        //系统通知\n          this.openNotification(data);\n      //}else if(data.cmd == \"user\"){\n        //用户消息\n      //  this.openNotification(data);\n      //}\n\n\n    },\n    websocketclose: function (e) {\n      console.log(\"connection closed (\" + e.code + \")\");\n    },\n\n    openNotification (data) {\n      var text = data.msgTxt;\n      const key = `open${Date.now()}`;\n      this.$notification.open({\n        message: '消息提醒',\n        placement:'bottomRight',\n        description: text,\n        key,\n        btn: (h)=>{\n          return h('a-button', {\n            props: {\n              type: 'primary',\n              size: 'small',\n            },\n            on: {\n              click: () => this.showDetail(key,data)\n            }\n          }, '查看详情')\n        },\n      });\n    },\n\n    showDetail(key,data){\n      this.$notification.close(key);\n      var id = data.msgId;\n      getAction(this.url.queryById,{id:id}).then((res) => {\n        if (res.success) {\n          var record = res.result;\n          this.showAnnouncement(record);\n        }\n      })\n\n    },\n  }\n}\n",{"version":3,"sources":["HeaderNotice.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8EA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA","file":"HeaderNotice.vue","sourceRoot":"src/components/tools","sourcesContent":["<template>\r\n  <a-popover\r\n    trigger=\"click\"\r\n    placement=\"bottomRight\"\r\n    :autoAdjustOverflow=\"true\"\r\n    :arrowPointAtCenter=\"true\"\r\n    overlayClassName=\"header-notice-wrapper\"\r\n    @visibleChange=\"handleHoverChange\"\r\n    :overlayStyle=\"{ width: '300px', top: '50px' }\">\r\n    <template slot=\"content\">\r\n      <a-spin :spinning=\"loadding\">\r\n        <a-tabs>\r\n          <a-tab-pane :tab=\"msg1Title\" key=\"1\">\r\n            <!--<a-list>\r\n              <a-list-item>\r\n                <a-list-item-meta title=\"你收到了 14 份新周报\" description=\"一年前\">\r\n                  <a-avatar style=\"background-color: white\" slot=\"avatar\" src=\"https://gw.alipayobjects.com/zos/rmsportal/ThXAXghbEsBCCSDihZxY.png\"/>\r\n                </a-list-item-meta>\r\n              </a-list-item>\r\n              <a-list-item>\r\n                <a-list-item-meta title=\"你推荐的 IT大牛 已通过第三轮面试\" description=\"一年前\">\r\n                  <a-avatar style=\"background-color: white\" slot=\"avatar\" src=\"https://gw.alipayobjects.com/zos/rmsportal/OKJXDXrmkNshAMvwtvhu.png\"/>\r\n                </a-list-item-meta>\r\n              </a-list-item>\r\n              <a-list-item>\r\n                <a-list-item-meta title=\"这种模板可以区分多种通知类型\" description=\"一年前\">\r\n                  <a-avatar style=\"background-color: white\" slot=\"avatar\" src=\"https://gw.alipayobjects.com/zos/rmsportal/kISTdvpyTAhtGxpovNWd.png\"/>\r\n                </a-list-item-meta>\r\n              </a-list-item>\r\n            </a-list>-->\r\n            <a-list>\r\n              <a-list-item :key=\"index\" v-for=\"(record, index) in announcement1\">\r\n                <div style=\"margin-left: 5%;width: 80%\">\r\n                  <p><a @click=\"showAnnouncement(record)\">标题：{{ record.titile }}</a></p>\r\n                  <p style=\"color: rgba(0,0,0,.45);margin-bottom: 0px\">{{ record.createTime }} 发布</p>\r\n                </div>\r\n                <div style=\"text-align: right\">\r\n                  <a-tag @click=\"showAnnouncement(record)\" v-if=\"record.priority === 'L'\" color=\"blue\">一般消息</a-tag>\r\n                  <a-tag @click=\"showAnnouncement(record)\" v-if=\"record.priority === 'M'\" color=\"orange\">重要消息</a-tag>\r\n                  <a-tag @click=\"showAnnouncement(record)\" v-if=\"record.priority === 'H'\" color=\"red\">紧急消息</a-tag>\r\n                </div>\r\n              </a-list-item>\r\n              <div style=\"margin-top: 5px;text-align: center\">\r\n                <a-button @click=\"toMyAnnouncement()\" type=\"dashed\" block>查看更多</a-button>\r\n              </div>\r\n            </a-list>\r\n          </a-tab-pane>\r\n          <a-tab-pane :tab=\"msg2Title\" key=\"2\">\r\n            <a-list>\r\n              <a-list-item :key=\"index\" v-for=\"(record, index) in announcement2\">\r\n                <div style=\"margin-left: 5%;width: 80%\">\r\n                  <p><a @click=\"showAnnouncement(record)\">标题：{{ record.titile }}</a></p>\r\n                  <p style=\"color: rgba(0,0,0,.45);margin-bottom: 0px\">{{ record.createTime }} 发布</p>\r\n                </div>\r\n                <div style=\"text-align: right\">\r\n                  <a-tag @click=\"showAnnouncement(record)\" v-if=\"record.priority === 'L'\" color=\"blue\">一般消息</a-tag>\r\n                  <a-tag @click=\"showAnnouncement(record)\" v-if=\"record.priority === 'M'\" color=\"orange\">重要消息</a-tag>\r\n                  <a-tag @click=\"showAnnouncement(record)\" v-if=\"record.priority === 'H'\" color=\"red\">紧急消息</a-tag>\r\n                </div>\r\n              </a-list-item>\r\n              <div style=\"margin-top: 5px;text-align: center\">\r\n                <a-button @click=\"toMyAnnouncement()\" type=\"dashed\" block>查看更多</a-button>\r\n              </div>\r\n            </a-list>\r\n          </a-tab-pane>\r\n        </a-tabs>\r\n      </a-spin>\r\n    </template>\r\n    <span @click=\"fetchNotice\" class=\"header-notice\">\r\n      <a-badge :count=\"msgTotal\">\r\n        <a-icon style=\"font-size: 16px; padding: 4px\" type=\"bell\" />\r\n      </a-badge>\r\n    </span>\r\n    <show-announcement ref=\"ShowAnnouncement\" @ok=\"modalFormOk\"></show-announcement>\r\n  </a-popover>\r\n</template>\r\n\r\n<script>\r\n  import { getAction,putAction } from '@/api/manage'\r\n  import ShowAnnouncement from './ShowAnnouncement'\r\n  import store from '@/store/'\r\n\r\n  export default {\r\n    name: \"HeaderNotice\",\r\n    components: {\r\n      ShowAnnouncement,\r\n    },\r\n    data () {\r\n      return {\r\n        loadding: false,\r\n        url:{\r\n          listCementByUser:\"/sys/annountCement/listByUser\",\r\n          editCementSend:\"/sys/sysAnnouncementSend/editByAnntIdAndUserId\",\r\n          queryById:\"/sys/annountCement/queryById\",\r\n        },\r\n        hovered: false,\r\n        announcement1:[],\r\n        announcement2:[],\r\n        msg1Count:\"3\",\r\n        msg2Count:\"0\",\r\n        msg1Title:\"通知(3)\",\r\n        msg2Title:\"\",\r\n        stopTimer:false,\r\n      }\r\n    },\r\n    computed:{\r\n      msgTotal () {\r\n        return parseInt(this.msg1Count)+parseInt(this.msg2Count);\r\n      }\r\n    },\r\n    mounted() {\r\n      this.loadData();\r\n      //this.timerFun();\r\n      this.initWebSocket();\r\n    },\r\n    destroyed: function () { // 离开页面生命周期函数\r\n      this.websocketclose();\r\n    },\r\n    methods: {\r\n      timerFun() {\r\n        this.stopTimer = false;\r\n        let myTimer = setInterval(()=>{\r\n          // 停止定时器\r\n          if (this.stopTimer == true) {\r\n            clearInterval(myTimer);\r\n            return;\r\n          }\r\n          this.loadData()\r\n        },6000)\r\n      },\r\n      loadData (){\r\n        try {\r\n          // 获取系统消息\r\n          getAction(this.url.listCementByUser).then((res) => {\r\n            if (res.success) {\r\n              this.announcement1 = res.result.anntMsgList;\r\n              this.msg1Count = res.result.anntMsgTotal;\r\n              this.msg1Title = \"通知(\" + res.result.anntMsgTotal + \")\";\r\n              this.announcement2 = res.result.sysMsgList;\r\n              this.msg2Count = res.result.sysMsgTotal;\r\n              this.msg2Title = \"系统消息(\" + res.result.sysMsgTotal + \")\";\r\n            }\r\n          }).catch(error => {\r\n            console.log(\"系统消息通知异常\",error);//这行打印permissionName is undefined\r\n            this.stopTimer = true;\r\n            console.log(\"清理timer\");\r\n          });\r\n        } catch (err) {\r\n          this.stopTimer = true;\r\n          console.log(\"通知异常\",err);\r\n        }\r\n      },\r\n      fetchNotice () {\r\n        if (this.loadding) {\r\n          this.loadding = false\r\n          return\r\n        }\r\n        this.loadding = true\r\n        setTimeout(() => {\r\n          this.loadding = false\r\n        }, 200)\r\n      },\r\n      showAnnouncement(record){\r\n        putAction(this.url.editCementSend,{anntId:record.id}).then((res)=>{\r\n          if(res.success){\r\n            this.loadData();\r\n          }\r\n        });\r\n        this.hovered = false;\r\n        this.$refs.ShowAnnouncement.detail(record);\r\n      },\r\n      toMyAnnouncement(){\r\n\r\n        this.$router.push({\r\n          path: '/isps/userAnnouncement',\r\n          name: 'isps-userAnnouncement'\r\n        });\r\n      },\r\n      modalFormOk(){\r\n      },\r\n      handleHoverChange (visible) {\r\n        this.hovered = visible;\r\n      },\r\n\r\n      initWebSocket: function () {\r\n        // WebSocket与普通的请求所用协议有所不同，ws等同于http，wss等同于https\r\n        var userId = store.getters.userInfo.id;\r\n        var url = window._CONFIG['domianURL'].replace(\"https://\",\"wss://\").replace(\"http://\",\"ws://\")+\"/websocket/\"+userId;\r\n        //console.log(url);\r\n        this.websock = new WebSocket(url);\r\n        this.websock.onopen = this.websocketonopen;\r\n        this.websock.onerror = this.websocketonerror;\r\n        this.websock.onmessage = this.websocketonmessage;\r\n        this.websock.onclose = this.websocketclose;\r\n      },\r\n      websocketonopen: function () {\r\n        console.log(\"WebSocket连接成功\");\r\n      },\r\n      websocketonerror: function (e) {\r\n        console.log(\"WebSocket连接发生错误\");\r\n      },\r\n      websocketonmessage: function (e) {\r\n        console.log(\"-----接收消息-------\",e.data);\r\n        var data = eval(\"(\" + e.data + \")\"); //解析对象\r\n        this.loadData();\r\n        //if(data.cmd == \"topic\"){\r\n          //系统通知\r\n            this.openNotification(data);\r\n        //}else if(data.cmd == \"user\"){\r\n          //用户消息\r\n        //  this.openNotification(data);\r\n        //}\r\n\r\n\r\n      },\r\n      websocketclose: function (e) {\r\n        console.log(\"connection closed (\" + e.code + \")\");\r\n      },\r\n\r\n      openNotification (data) {\r\n        var text = data.msgTxt;\r\n        const key = `open${Date.now()}`;\r\n        this.$notification.open({\r\n          message: '消息提醒',\r\n          placement:'bottomRight',\r\n          description: text,\r\n          key,\r\n          btn: (h)=>{\r\n            return h('a-button', {\r\n              props: {\r\n                type: 'primary',\r\n                size: 'small',\r\n              },\r\n              on: {\r\n                click: () => this.showDetail(key,data)\r\n              }\r\n            }, '查看详情')\r\n          },\r\n        });\r\n      },\r\n\r\n      showDetail(key,data){\r\n        this.$notification.close(key);\r\n        var id = data.msgId;\r\n        getAction(this.url.queryById,{id:id}).then((res) => {\r\n          if (res.success) {\r\n            var record = res.result;\r\n            this.showAnnouncement(record);\r\n          }\r\n        })\r\n\r\n      },\r\n    }\r\n  }\r\n</script>\r\n\r\n<style lang=\"css\">\r\n  .header-notice-wrapper {\r\n    top: 50px !important;\r\n  }\r\n</style>\r\n<style lang=\"scss\" scoped>\r\n  .header-notice{\r\n    display: inline-block;\r\n    transition: all 0.3s;\r\n\r\n    span {\r\n      vertical-align: initial;\r\n    }\r\n  }\r\n</style>"]}]}