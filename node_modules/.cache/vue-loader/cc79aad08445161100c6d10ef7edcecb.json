{"remainingRequest":"C:\\xxm\\work\\jd\\fore\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\xxm\\work\\jd\\fore\\src\\views\\oaBus\\modules\\BusFunctionModal.vue?vue&type=script&lang=js&","dependencies":[{"path":"C:\\xxm\\work\\jd\\fore\\src\\views\\oaBus\\modules\\BusFunctionModal.vue","mtime":1579052728639},{"path":"C:\\xxm\\work\\jd\\fore\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1570779194464},{"path":"C:\\xxm\\work\\jd\\fore\\node_modules\\babel-loader\\lib\\index.js","mtime":1570779245522},{"path":"C:\\xxm\\work\\jd\\fore\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1570779194464},{"path":"C:\\xxm\\work\\jd\\fore\\node_modules\\vue-loader\\lib\\index.js","mtime":1570779225726}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport {httpAction, getAction} from '@/api/manage'\nimport pick from 'lodash.pick'\nimport BusPageListSelect from '../BusPageListSelect'\nimport {JeecgListMixin} from '@/mixins/JeecgListMixin'\n\n//import JSelectDepartModal from './modal/JSelectDepartModal'\nimport moment from \"moment\"\nimport JSelectDepartModal from \"../../../components/jeecgbiz/modal/JSelectDepartModal\";\nimport BusFunctionViewModal from \"./BusFunctionViewModal\";\nimport BusFunctionProcButtonModal from \"./BusFunctionProcButtonModal\";\nimport BusPageDetailDef from \"../BusPageDetailDef\";\nimport BusFunNoProcButton from \"./BusFunNoProcButton\";\n\nexport default {\n  name: \"BusFunctionModal\",\n  mixins: [JeecgListMixin],\n  inject: ['reload'],\n  components: {\n    BusFunNoProcButton,\n    BusPageDetailDef,\n    BusFunctionProcButtonModal,\n    BusFunctionViewModal,\n    JSelectDepartModal,\n    BusPageListSelect,\n  },\n  data() {\n    return {\n      title: \"操作\",\n      visible: false,\n      nowKey: '',\n      selectModelData: [],\n      procButtonOpinion: {},      //按钮意见数据\n      //procButtonOpinionObj: {},   //按钮意见数据Obj\n      roleObj: {},                //数据查看权限数据,放角色id\n      deptObj: {},                //部门的相关数据\n      dbtable: [],\n      roleList: [],               //角色字典数据\n      departList: [],             //部门字典数据\n      nameProc: '',\n      nameOpinion: '',\n      nameButton: '',\n      nameButton2: '',\n      iBMId: '',\n      modelWidth: '60%',\n      procDefKv: '',\n      showFlag: false,\n      showFlag2: false,\n      dataSourceView: [],\n      dataSourceUnit: [],\n      ipaginationView: {\n        current: 1,\n        pageSize: 100,\n        showTotal: (total, range) => {\n          return range[0] + \"-\" + range[1] + \" 共\" + total + \"条\"\n        },\n        showQuickJumper: true,\n        showSizeChanger: true,\n        total: 0,\n      },\n      ipaginationUnit: {\n        current: 1,\n        pageSize: 100,\n        showTotal: (total, range) => {\n          return range[0] + \"-\" + range[1] + \" 共\" + total + \"条\"\n        },\n        showQuickJumper: true,\n        showSizeChanger: true,\n        total: 0,\n      },\n      columnsUnit: [\n        {\n          title: '机构名字',\n          align: \"center\",\n          dataIndex: 'sunitId',\n          customRender: (text) => {\n            for (let i = 0; i < this.departList.length; i++) {\n              if (text == this.departList[i].value) {\n                return this.departList[i].text;\n              }\n            }\n            return text;\n          }\n        },\n        {\n          title: '部门名称',\n          align: \"center\",\n          dataIndex: 'sdeptId',\n          customRender: (text) => {\n            for (let i = 0; i < this.departList.length; i++) {\n              if (text == this.departList[i].value) {\n                return this.departList[i].text;\n              }\n            }\n            return text;\n          }\n        },\n        {\n          title: '操作',\n          dataIndex: 'action',\n          align: \"center\",\n          scopedSlots: {customRender: 'action'},\n        }\n      ],\n      columnsView: [\n        {\n          title: '权限类型',\n          align: \"center\",\n          dataIndex: 'itype',\n          customRender: (text) => {\n            if (text == 0) {\n              return '角色';\n            } else if (text == 1) {\n              return '角色+机构'\n            } else if (text == 2) {\n              return '角色+部门'\n            } else if (text == 3) {\n              return '角色+分管部门'\n            } else {\n              return text;\n            }\n          }\n\n        },\n        {\n          title: '角色名称',\n          align: \"center\",\n          dataIndex: 'iroleId',\n          customRender: (text) => {\n            for (let i = 0; i < this.roleList.length; i++) {\n              if (text == this.roleList[i].value) {\n                return this.roleList[i].text;\n              }\n            }\n            return text;\n          }\n        },\n        {\n          title: '操作',\n          dataIndex: 'action',\n          align: \"center\",\n          scopedSlots: {customRender: 'action'},\n        }\n      ],\n      model: {},\n      labelCol: {\n        xs: {span: 24},\n        sm: {span: 5},\n      },\n      wrapperCol: {\n        xs: {span: 24},\n        sm: {span: 16},\n      },\n      confirmLoading: false,\n      form: this.$form.createForm(this),\n      validatorRules: {},\n      url: {\n        add: \"/oaBus/busFunction/add\",\n        edit: \"/oaBus/busFunction/edit\",\n        queryInit: \"/oaBus/busFunction/queryInit\",\n        queryRoleAndDepart: \"/oaBus/busFunction/queryRoleAndDepart\",\n        getbusPageDetailList: \"/oaBus/oaBusdata/getPageDataForm\",\n        orderTicketList: \"/test/jeecgOrderMain/queryOrderTicketListByMainId\",\n        list: \"/oaBus/busFunction/queryInit\",\n      },\n    }\n  },\n  created() {\n\n  },\n  destroyed() {\n    this.close();\n  },\n  methods: {\n\n    //查找数组下标\n    findIndex(rec,array){\n      for (let i = 0; i < array.length; i++) {\n        if (rec == array[i]) {\n          return i;\n        }\n      }\n    },\n    handleEditView(record) {\n      let i = this.findIndex(record,this.dataSourceView);\n      this.dataSourceView.splice(i,1)\n    },\n    handleEditUnit(record) {\n      let i = this.findIndex(record,this.dataSourceUnit);\n      this.dataSourceUnit.splice(i,1)\n    },\n\n    /* handleTableChange(pagination){\n       console.log(pagination);\n     },*/\n    //选择无流程按钮后的逻辑\n    busFunNoProcBut(res) {\n      console.log(res)\n      this.showFlag = false;\n      this.showFlag2 = true;\n      this.nameButton2 = res.sbuttonSetName;\n      if(this.procButtonOpinion == null){\n        this.procButtonOpinion = {};\n      }\n      this.procButtonOpinion.procDefKey = '';\n      this.procButtonOpinion.iprocOpinionId = '';\n      this.procButtonOpinion.iprocButtonId = res.iid;\n      console.log(JSON.stringify(this.procButtonOpinion))\n    },\n    busFunProcButOpin(procButtonOpinion) {\n      //this.procButtonOpinion = {};\n      this.procButtonOpinion.procDefKey = procButtonOpinion.procDefKey.val;\n      this.procButtonOpinion.iprocOpinionId = procButtonOpinion.iprocOpinionId.iid;\n      this.procButtonOpinion.iprocButtonId = procButtonOpinion.iprocButtonId.iid;\n\n      this.showFlag2 = false;\n      this.showFlag = true;\n      this.nameProc = procButtonOpinion.procDefKey.key;\n      this.nameOpinion = procButtonOpinion.iprocOpinionId.sprocOpinionName;\n      this.nameButton = procButtonOpinion.iprocButtonId.sbuttonSetName;\n      //console.log(this.procButtonOpinionObj)\n    },\n    /*流程选择触发事件*/\n    procFunction(e) {\n      let param = '';\n      if(this.procButtonOpinion != undefined && this.procButtonOpinion != null ){\n        param = this.procButtonOpinion ;\n      }\n\n      if (e == 1) {\n        this.$refs.refBusFunctionProcButtonModal.add(param);\n      } else {\n        this.$refs.BusFunNoProcButtonRef.add(param);\n      }\n\n\n    },\n    /*选择查看权限*/\n    busFunctionViewModalOk(roleObj) {\n      this.dataSourceView.push(roleObj)\n      console.log(roleObj);\n    },\n    checkView() {\n      //console.log(\"业务机构选择\");\n      this.$refs.refBusFunctionViewModal.add();\n    },\n    /*选择业务机构*/\n    checkUnit() {\n      //console.log(\"业务机构选择\");\n      this.$refs.innerDepartSelectModal.show()\n    },\n    /*选择业务机构成功后返回后执行的函数*/\n    checkUnitOk(rows, idstr) {\n\n      console.log(\"当前选中部门ID\", idstr)\n      if (!rows) {\n        this.departNames = ''\n        this.departIds = ''\n      } else {\n        this.deptObj = {}\n        for (let item of rows) {\n          console.log(\"当前选中部门\", item)\n          if (item.orgType == 1) {\n            this.deptObj = {\"sunitId\": item.id}\n          } else {\n            this.deptObj = {\"sdeptId\": item.id, \"sunitId\": item.parentId}\n          }\n          this.dataSourceUnit.push(this.deptObj)\n        }\n      }\n      //this.$emit(\"change\",this.departIds)\n    },\n    add() {\n      this.edit({});\n    },\n    edit(record) {\n      console.log(record) ;\n      this.nowKey = (new Date()).valueOf();\n      getAction(this.url.queryRoleAndDepart).then((res) => {\n        if(res.success){\n          this.roleList = res.result.roleList;\n          this.departList = res.result.departList;\n\n        }else{\n        }\n      });\n      this.getSelection();\n      this.form.resetFields();\n      this.model = Object.assign({}, record);\n      this.visible = true;\n      this.$nextTick(() => {\n        this.form.setFieldsValue(pick(this.model, 'ibusModelId', 'sname', 'ipageId', 'sbusLeftParameter','slevel', 'iisUnit', 'iisDept', 'sbusRightParameter', 'iisEditor', 'iisLimits', 'iisEs', 'iisProc', 'iprocSetId', 'screateBy', 'supdateBy'))\n      });\n      if (this.model.iid) {\n        //查询出对应的基础数据\n        getAction(this.url.queryInit, {functionId: this.model.iid}).then((rec) => {\n          //console.log(JSON.stringify(rec))\n          this.dataSourceUnit = rec.result.unitList;\n          this.ipaginationUnit.total = rec.result.unitList.length;\n          this.dataSourceView = rec.result.viewList;\n          this.ipaginationView.total = rec.result.viewList.length;\n          this.procButtonOpinion = rec.result.busProcSet\n\n          //如果没有流程，则显示没有流程的按钮\n          if (this.model.iisProc == 0) {\n            this.showFlag = false;\n            this.showFlag2 = true;\n            //console.log(\"++++++++\"+JSON.stringify(this.model))\n            if (rec.result.procButton != undefined) {\n              this.nameButton2 = rec.result.procButton.sbuttonSetName;\n            }\n          }\n          //如果有流程的话，就将数据\n          else if (this.model.iisProc == 1) {\n            this.showFlag = true;\n            this.showFlag2 = false;\n            if (rec.result.procKey != undefined) {\n              this.nameProc = rec.result.procKey[0];\n            }\n            if (rec.result.procOpinion != undefined) {\n              this.nameOpinion = rec.result.procOpinion.sprocOpinionName;\n            }\n            if (rec.result.procButton != undefined) {\n              this.nameButton = rec.result.procButton.sbuttonSetName;\n            }\n          } else {\n            this.showFlag = false;\n            this.showFlag2 = false;\n          }\n        })\n      }\n\n    },\n    close() {\n\n      this.deptObj = {};\n      this.roleObj = {};\n      this.procButtonOpinion = {};\n      this.showFlag = false;\n      this.showFlag2 = false;\n      this.dataSourceUnit = [];\n      this.dataSourceView = [];\n      this.ipaginationUnit = {},\n      this.ipaginationView = {},\n      this.$emit('close');\n      //this.reload();\n      this.visible = false;\n    },\n    selPage() {\n      this.$refs.selectPageModel.show()\n    },\n\n    //选择页面\n    selectPageOk(data) {\n      this.model.ipageId = data[0];\n      this.$nextTick(() => {\n        this.form.setFieldsValue(pick(this.model, 'ipageId'))\n      });\n\n    },\n    handleOk() {\n      const that = this;\n      // 触发表单验证\n      this.form.validateFields((err, values) => {\n\n        if (!err) {\n          console.log(\"in  \" + values);\n          that.confirmLoading = true;\n          that.confirmLoading = true;\n          let httpurl = '';\n          let method = '';\n          if (!this.model.iid) {\n            httpurl += this.url.add;\n            method = 'post';\n          } else {\n            httpurl += this.url.edit;\n            method = 'put';\n          }\n          /*let httpurl = '/oaBus/busFunction/add';\n          let method = 'post';*/\n          let orderMainData = Object.assign(this.model, values);\n          console.log(\"orderMainData \" + orderMainData);\n\n          /*  if(JSON.stringify(this.deptObj) == \"{}\" ){\n\n            }*/\n          let formData = {\n            ...orderMainData,\n            busFunctionUnit: this.dataSourceUnit,\n            busFunctionView: this.dataSourceView,\n            busProcSet: this.procButtonOpinion\n          }\n\n          console.log(formData)\n          httpAction(httpurl, formData, method).then((res) => {\n            if (res.success) {\n              that.$message.success(res.message);\n              that.$emit('ok');\n            } else {\n              that.$message.warning(res.message);\n            }\n          }).finally(() => {\n            that.confirmLoading = false;\n            that.close();\n          })\n\n        }\n      })\n    },\n    handleCancel() {\n      this.close()\n    },\n    //得到model和page的数据列，填充对应的下拉选\n    getSelection() {\n      let url = \"/oaBus/busModel/modelList\";\n      getAction(url).then((res) => {\n        /*map.put(\"modelList\",paperList);\n        map.put(\"pageList\",busPageList);*/\n        this.selectModelData = res.result.modelList;\n        this.dbtable = res.result.pageList;\n      })\n    }\n\n  }\n}\n",{"version":3,"sources":["BusFunctionModal.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqOA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA","file":"BusFunctionModal.vue","sourceRoot":"src/views/oaBus/modules","sourcesContent":["<template>\r\n  <a-modal\r\n    :title=\"title\"\r\n    :width=\"modelWidth\"\r\n    :visible=\"visible\"\r\n    :key=\"nowKey\"\r\n    :confirmLoading=\"confirmLoading\"\r\n    @ok=\"handleOk\"\r\n    @cancel=\"handleCancel\">\r\n\r\n    <div style=\"height: 500px; width:95% ;overflow: auto\">\r\n      <a-spin :spinning=\"confirmLoading\">\r\n        <a-form :form=\"form\">\r\n          <!-- 主表单区域 -->\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"业务分类\">\r\n            <a-select v-model=\"iBMId\" v-decorator=\"[ 'ibusModelId', {rules:[{required:true}]}]\">\r\n              <a-select-option v-for=\"(item,index) in selectModelData\" :key=\"index\" :value=\"item.iid\">\r\n                {{item.sname}}\r\n              </a-select-option>\r\n            </a-select>\r\n            <!--<a-input-number v-decorator=\"[ 'iBusModelId', {}]\" />-->\r\n          </a-form-item>\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"业务名称\">\r\n            <a-input placeholder=\"请输入业务类型名称\" v-decorator=\"['sname', {rules:[{required:true,message:'业务名称必须输入！！！'}]}]\"/>\r\n          </a-form-item>\r\n\r\n          <!-- <a-form-item\r\n             v-show=\"false\"\r\n             :labelCol=\"labelCol\"\r\n             :wrapperCol=\"wrapperCol\"\r\n             label=\"详情页面\">\r\n             <a-input-number placeholder=\"请选择对应的页面\" disabled style=\"width: calc(100% - 130px);\"\r\n                             v-decorator=\"[ 'ipageId', {}]\">\r\n\r\n             </a-input-number>\r\n           </a-form-item>-->\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"详情页面\">\r\n            <a-select placeholder=\"请选择对应的页面\" style=\"width: calc(100% - 130px);\" disabled v-decorator=\"[ 'ipageId', {rules:[{required:true}]}]\">\r\n              <a-select-option v-for=\"(item,index) in dbtable\" :key=\"index\" :value=\"item.iid\">\r\n                {{item.spageName}}\r\n              </a-select-option>\r\n            </a-select>\r\n            <!--<a-input-number placeholder=\"请选择对应的页面\" disabled style=\"width: calc(100% - 130px);\">\r\n\r\n            </a-input-number>-->\r\n            <span style=\"display: inline-block;width:130px;float: right;overflow: hidden;\">\r\n              <a-button type=\"primary\" @click=\"selPage\" icon=\"search\" style=\"width: 130px\">选择模板</a-button>\r\n            </span>\r\n          </a-form-item>\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"左侧参数\">\r\n            <a-input placeholder=\"请输入左侧参数\" v-decorator=\"['sbusLeftParameter', {}]\"/>\r\n          </a-form-item>\r\n\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"右侧参数\">\r\n            <a-input placeholder=\"请输入右侧参数\" v-decorator=\"[ 'sbusRightParameter', {}]\"/>\r\n            <!--<span style=\"display: inline-block;width:81px;float: right;overflow: hidden;\">\r\n              <a-button type=\"primary\" @click=\"openBusPage\" icon=\"search\" style=\"width: 81px\">选择</a-button>\r\n            </span>-->\r\n          </a-form-item>\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"业务优先级\">\r\n            <a-input placeholder=\"业务优先级\" v-decorator=\"[ 'slevel', {rules:[{pattern:'^\\\\d{0,2}$',message:'请输入两位以内的数字'}]}]\"/>\r\n            <!--<span style=\"display: inline-block;width:81px;float: right;overflow: hidden;\">\r\n              <a-button type=\"primary\" @click=\"openBusPage\" icon=\"search\" style=\"width: 81px\">选择</a-button>\r\n            </span>-->\r\n          </a-form-item>\r\n\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"插入机构\">\r\n            <a-radio-group :defaultValue=\"0\" v-decorator=\"['iisUnit', {}]\">\r\n              <a-radio :value=\"1\">是</a-radio>\r\n              <a-radio :value=\"0\">否</a-radio>\r\n            </a-radio-group>\r\n          </a-form-item>\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"插入部门\">\r\n            <a-radio-group :defaultValue=\"0\" v-decorator=\"['iisDept', {}]\">\r\n              <a-radio :value=\"1\">是</a-radio>\r\n              <a-radio :value=\"0\">否</a-radio>\r\n            </a-radio-group>\r\n            <!--<a-input placeholder=\"请输入是否插入部门\" v-decorator=\"['iIsDept', {}]\" />-->\r\n          </a-form-item>\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"编辑器\">\r\n            <a-radio-group :defaultValue=\"0\" v-decorator=\"['iisEditor', {}]\">\r\n              <a-radio :value=\"1\">是</a-radio>\r\n              <a-radio :value=\"0\">否</a-radio>\r\n            </a-radio-group>\r\n            <!--<a-input placeholder=\"请输入是否有编辑器(1、0)\" v-decorator=\"['iIsEditor', {}]\" />&ndash;&gt;-->\r\n          </a-form-item>\r\n\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"发送范围\">\r\n            <a-radio-group :defaultValue=\"0\" v-decorator=\"['iisLimits', {}]\">\r\n              <a-radio :value=\"1\">是</a-radio>\r\n              <a-radio :value=\"0\">否</a-radio>\r\n            </a-radio-group>\r\n          </a-form-item>\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"全文检索\">\r\n            <a-radio-group :defaultValue=\"0\" v-decorator=\"['iisEs', {}]\">\r\n              <a-radio :value=\"1\">是</a-radio>\r\n              <a-radio :value=\"0\">否</a-radio>\r\n            </a-radio-group>\r\n            <!--<a-input placeholder=\"请输入是否纳入全文检索(1、0)\" v-decorator=\"['iIsEs', {}]\" />-->\r\n          </a-form-item>\r\n\r\n          <a-form-item\r\n            :labelCol=\"labelCol\"\r\n            :wrapperCol=\"wrapperCol\"\r\n            label=\"流程审批\">\r\n            <a-radio-group v-model=\"procDefKv\" :defaultValue=\"0\" v-decorator=\"['iisProc', {}]\">\r\n              <a-radio @click=\"procFunction(1)\" :value=\"1\">是</a-radio>\r\n              <a-radio @click=\"procFunction(0)\" :value=\"0\">否</a-radio>\r\n            </a-radio-group>\r\n\r\n            <!--<a-input placeholder=\"请输入是否是流程审批(1、0)\" v-decorator=\"['iIsLimits', {}]\" />-->\r\n          </a-form-item>\r\n          <div class=\"returnBox\" v-show=\"showFlag\">\r\n            <h3>流程配置</h3>\r\n            <div>流程：{{nameProc}}</div>\r\n            <div>意见：{{nameOpinion}}</div>\r\n            <div>按钮：{{nameButton}}</div>\r\n          </div>\r\n          <div class=\"returnBox\" v-show=\"showFlag2\">\r\n            <h3>流程配置</h3>\r\n            <div>按钮：{{nameButton2}}</div>\r\n          </div>\r\n          <div class=\"ant-row ant-form-item\">\r\n            <div class=\"ant-col-xs-24 ant-col-sm-5 ant-form-item-label\">\r\n              <a-button @click=\"checkUnit\" type=\"primary\">业务所属机构</a-button>\r\n            </div>\r\n          </div>\r\n          <!--机构的表格-->\r\n          <a-table\r\n            ref=\"table\"\r\n            size=\"middle\"\r\n            bordered\r\n            rowKey=\"index\"\r\n            :columns=\"columnsUnit\"\r\n            :dataSource=\"dataSourceUnit\"\r\n            :pagination=\"ipaginationUnit\"\r\n            :loading=\"loading\"\r\n            :rowSelection=\"{selectedRowKeys: selectedRowKeys, onChange: onSelectChange}\"\r\n            @change=\"handleTableChange\">\r\n          <span slot=\"action\" slot-scope=\"text, record\">\r\n            <a @click=\"handleEditUnit(record)\">删除</a>\r\n          </span>\r\n          </a-table>\r\n          <div class=\"ant-row ant-form-item\">\r\n            <div class=\"ant-col-xs-24 ant-col-sm-5 ant-form-item-label\">\r\n              <a-button @click=\"checkView\" type=\"primary\">数据查看权限</a-button>\r\n            </div>\r\n          </div>\r\n          <!--权限的表格-->\r\n          <a-table\r\n            ref=\"table\"\r\n            size=\"middle\"\r\n            bordered\r\n            rowKey=\"index\"\r\n            :columns=\"columnsView\"\r\n            :dataSource=\"dataSourceView\"\r\n            :pagination=\"ipaginationView\"\r\n            :loading=\"loading\"\r\n            :rowSelection=\"{selectedRowKeys: selectedRowKeys, onChange: onSelectChange}\"\r\n            @change=\"handleTableChange\">\r\n          <span slot=\"action\" slot-scope=\"text, record\">\r\n            <a @click=\"handleEditView(record)\">删除</a>\r\n          </span>\r\n          </a-table>\r\n\r\n\r\n        </a-form>\r\n      </a-spin>\r\n      <!--\r\n      :modal-width=\"modalWidth\"\r\n        :multi=\"multi\"\r\n        :rootOpened=\"rootOpened\"\r\n        :depart-id=\"value\"\r\n        选择部门\r\n        -->\r\n\r\n    </div>\r\n    <!--数据查看权限的modal-->\r\n    <j-select-depart-modal ref=\"innerDepartSelectModal\" @ok=\"checkUnitOk\"/>\r\n    <bus-function-view-modal ref=\"refBusFunctionViewModal\" @ok=\"busFunctionViewModalOk\"/>\r\n    <bus-function-proc-button-modal ref=\"refBusFunctionProcButtonModal\" @ok=\"busFunProcButOpin\"/>\r\n    <bus-page-list-select ref=\"selectPageModel\" @selectFinished=\"selectPageOk\"></bus-page-list-select>\r\n    <bus-fun-no-proc-button ref=\"BusFunNoProcButtonRef\" @ok=\"busFunNoProcBut\"/>\r\n  </a-modal>\r\n</template>\r\n\r\n<script>\r\n  import {httpAction, getAction} from '@/api/manage'\r\n  import pick from 'lodash.pick'\r\n  import BusPageListSelect from '../BusPageListSelect'\r\n  import {JeecgListMixin} from '@/mixins/JeecgListMixin'\r\n\r\n  //import JSelectDepartModal from './modal/JSelectDepartModal'\r\n  import moment from \"moment\"\r\n  import JSelectDepartModal from \"../../../components/jeecgbiz/modal/JSelectDepartModal\";\r\n  import BusFunctionViewModal from \"./BusFunctionViewModal\";\r\n  import BusFunctionProcButtonModal from \"./BusFunctionProcButtonModal\";\r\n  import BusPageDetailDef from \"../BusPageDetailDef\";\r\n  import BusFunNoProcButton from \"./BusFunNoProcButton\";\r\n\r\n  export default {\r\n    name: \"BusFunctionModal\",\r\n    mixins: [JeecgListMixin],\r\n    inject: ['reload'],\r\n    components: {\r\n      BusFunNoProcButton,\r\n      BusPageDetailDef,\r\n      BusFunctionProcButtonModal,\r\n      BusFunctionViewModal,\r\n      JSelectDepartModal,\r\n      BusPageListSelect,\r\n    },\r\n    data() {\r\n      return {\r\n        title: \"操作\",\r\n        visible: false,\r\n        nowKey: '',\r\n        selectModelData: [],\r\n        procButtonOpinion: {},      //按钮意见数据\r\n        //procButtonOpinionObj: {},   //按钮意见数据Obj\r\n        roleObj: {},                //数据查看权限数据,放角色id\r\n        deptObj: {},                //部门的相关数据\r\n        dbtable: [],\r\n        roleList: [],               //角色字典数据\r\n        departList: [],             //部门字典数据\r\n        nameProc: '',\r\n        nameOpinion: '',\r\n        nameButton: '',\r\n        nameButton2: '',\r\n        iBMId: '',\r\n        modelWidth: '60%',\r\n        procDefKv: '',\r\n        showFlag: false,\r\n        showFlag2: false,\r\n        dataSourceView: [],\r\n        dataSourceUnit: [],\r\n        ipaginationView: {\r\n          current: 1,\r\n          pageSize: 100,\r\n          showTotal: (total, range) => {\r\n            return range[0] + \"-\" + range[1] + \" 共\" + total + \"条\"\r\n          },\r\n          showQuickJumper: true,\r\n          showSizeChanger: true,\r\n          total: 0,\r\n        },\r\n        ipaginationUnit: {\r\n          current: 1,\r\n          pageSize: 100,\r\n          showTotal: (total, range) => {\r\n            return range[0] + \"-\" + range[1] + \" 共\" + total + \"条\"\r\n          },\r\n          showQuickJumper: true,\r\n          showSizeChanger: true,\r\n          total: 0,\r\n        },\r\n        columnsUnit: [\r\n          {\r\n            title: '机构名字',\r\n            align: \"center\",\r\n            dataIndex: 'sunitId',\r\n            customRender: (text) => {\r\n              for (let i = 0; i < this.departList.length; i++) {\r\n                if (text == this.departList[i].value) {\r\n                  return this.departList[i].text;\r\n                }\r\n              }\r\n              return text;\r\n            }\r\n          },\r\n          {\r\n            title: '部门名称',\r\n            align: \"center\",\r\n            dataIndex: 'sdeptId',\r\n            customRender: (text) => {\r\n              for (let i = 0; i < this.departList.length; i++) {\r\n                if (text == this.departList[i].value) {\r\n                  return this.departList[i].text;\r\n                }\r\n              }\r\n              return text;\r\n            }\r\n          },\r\n          {\r\n            title: '操作',\r\n            dataIndex: 'action',\r\n            align: \"center\",\r\n            scopedSlots: {customRender: 'action'},\r\n          }\r\n        ],\r\n        columnsView: [\r\n          {\r\n            title: '权限类型',\r\n            align: \"center\",\r\n            dataIndex: 'itype',\r\n            customRender: (text) => {\r\n              if (text == 0) {\r\n                return '角色';\r\n              } else if (text == 1) {\r\n                return '角色+机构'\r\n              } else if (text == 2) {\r\n                return '角色+部门'\r\n              } else if (text == 3) {\r\n                return '角色+分管部门'\r\n              } else {\r\n                return text;\r\n              }\r\n            }\r\n\r\n          },\r\n          {\r\n            title: '角色名称',\r\n            align: \"center\",\r\n            dataIndex: 'iroleId',\r\n            customRender: (text) => {\r\n              for (let i = 0; i < this.roleList.length; i++) {\r\n                if (text == this.roleList[i].value) {\r\n                  return this.roleList[i].text;\r\n                }\r\n              }\r\n              return text;\r\n            }\r\n          },\r\n          {\r\n            title: '操作',\r\n            dataIndex: 'action',\r\n            align: \"center\",\r\n            scopedSlots: {customRender: 'action'},\r\n          }\r\n        ],\r\n        model: {},\r\n        labelCol: {\r\n          xs: {span: 24},\r\n          sm: {span: 5},\r\n        },\r\n        wrapperCol: {\r\n          xs: {span: 24},\r\n          sm: {span: 16},\r\n        },\r\n        confirmLoading: false,\r\n        form: this.$form.createForm(this),\r\n        validatorRules: {},\r\n        url: {\r\n          add: \"/oaBus/busFunction/add\",\r\n          edit: \"/oaBus/busFunction/edit\",\r\n          queryInit: \"/oaBus/busFunction/queryInit\",\r\n          queryRoleAndDepart: \"/oaBus/busFunction/queryRoleAndDepart\",\r\n          getbusPageDetailList: \"/oaBus/oaBusdata/getPageDataForm\",\r\n          orderTicketList: \"/test/jeecgOrderMain/queryOrderTicketListByMainId\",\r\n          list: \"/oaBus/busFunction/queryInit\",\r\n        },\r\n      }\r\n    },\r\n    created() {\r\n\r\n    },\r\n    destroyed() {\r\n      this.close();\r\n    },\r\n    methods: {\r\n\r\n      //查找数组下标\r\n      findIndex(rec,array){\r\n        for (let i = 0; i < array.length; i++) {\r\n          if (rec == array[i]) {\r\n            return i;\r\n          }\r\n        }\r\n      },\r\n      handleEditView(record) {\r\n        let i = this.findIndex(record,this.dataSourceView);\r\n        this.dataSourceView.splice(i,1)\r\n      },\r\n      handleEditUnit(record) {\r\n        let i = this.findIndex(record,this.dataSourceUnit);\r\n        this.dataSourceUnit.splice(i,1)\r\n      },\r\n\r\n      /* handleTableChange(pagination){\r\n         console.log(pagination);\r\n       },*/\r\n      //选择无流程按钮后的逻辑\r\n      busFunNoProcBut(res) {\r\n        console.log(res)\r\n        this.showFlag = false;\r\n        this.showFlag2 = true;\r\n        this.nameButton2 = res.sbuttonSetName;\r\n        if(this.procButtonOpinion == null){\r\n          this.procButtonOpinion = {};\r\n        }\r\n        this.procButtonOpinion.procDefKey = '';\r\n        this.procButtonOpinion.iprocOpinionId = '';\r\n        this.procButtonOpinion.iprocButtonId = res.iid;\r\n        console.log(JSON.stringify(this.procButtonOpinion))\r\n      },\r\n      busFunProcButOpin(procButtonOpinion) {\r\n        //this.procButtonOpinion = {};\r\n        this.procButtonOpinion.procDefKey = procButtonOpinion.procDefKey.val;\r\n        this.procButtonOpinion.iprocOpinionId = procButtonOpinion.iprocOpinionId.iid;\r\n        this.procButtonOpinion.iprocButtonId = procButtonOpinion.iprocButtonId.iid;\r\n\r\n        this.showFlag2 = false;\r\n        this.showFlag = true;\r\n        this.nameProc = procButtonOpinion.procDefKey.key;\r\n        this.nameOpinion = procButtonOpinion.iprocOpinionId.sprocOpinionName;\r\n        this.nameButton = procButtonOpinion.iprocButtonId.sbuttonSetName;\r\n        //console.log(this.procButtonOpinionObj)\r\n      },\r\n      /*流程选择触发事件*/\r\n      procFunction(e) {\r\n        let param = '';\r\n        if(this.procButtonOpinion != undefined && this.procButtonOpinion != null ){\r\n          param = this.procButtonOpinion ;\r\n        }\r\n\r\n        if (e == 1) {\r\n          this.$refs.refBusFunctionProcButtonModal.add(param);\r\n        } else {\r\n          this.$refs.BusFunNoProcButtonRef.add(param);\r\n        }\r\n\r\n\r\n      },\r\n      /*选择查看权限*/\r\n      busFunctionViewModalOk(roleObj) {\r\n        this.dataSourceView.push(roleObj)\r\n        console.log(roleObj);\r\n      },\r\n      checkView() {\r\n        //console.log(\"业务机构选择\");\r\n        this.$refs.refBusFunctionViewModal.add();\r\n      },\r\n      /*选择业务机构*/\r\n      checkUnit() {\r\n        //console.log(\"业务机构选择\");\r\n        this.$refs.innerDepartSelectModal.show()\r\n      },\r\n      /*选择业务机构成功后返回后执行的函数*/\r\n      checkUnitOk(rows, idstr) {\r\n\r\n        console.log(\"当前选中部门ID\", idstr)\r\n        if (!rows) {\r\n          this.departNames = ''\r\n          this.departIds = ''\r\n        } else {\r\n          this.deptObj = {}\r\n          for (let item of rows) {\r\n            console.log(\"当前选中部门\", item)\r\n            if (item.orgType == 1) {\r\n              this.deptObj = {\"sunitId\": item.id}\r\n            } else {\r\n              this.deptObj = {\"sdeptId\": item.id, \"sunitId\": item.parentId}\r\n            }\r\n            this.dataSourceUnit.push(this.deptObj)\r\n          }\r\n        }\r\n        //this.$emit(\"change\",this.departIds)\r\n      },\r\n      add() {\r\n        this.edit({});\r\n      },\r\n      edit(record) {\r\n        console.log(record) ;\r\n        this.nowKey = (new Date()).valueOf();\r\n        getAction(this.url.queryRoleAndDepart).then((res) => {\r\n          if(res.success){\r\n            this.roleList = res.result.roleList;\r\n            this.departList = res.result.departList;\r\n\r\n          }else{\r\n          }\r\n        });\r\n        this.getSelection();\r\n        this.form.resetFields();\r\n        this.model = Object.assign({}, record);\r\n        this.visible = true;\r\n        this.$nextTick(() => {\r\n          this.form.setFieldsValue(pick(this.model, 'ibusModelId', 'sname', 'ipageId', 'sbusLeftParameter','slevel', 'iisUnit', 'iisDept', 'sbusRightParameter', 'iisEditor', 'iisLimits', 'iisEs', 'iisProc', 'iprocSetId', 'screateBy', 'supdateBy'))\r\n        });\r\n        if (this.model.iid) {\r\n          //查询出对应的基础数据\r\n          getAction(this.url.queryInit, {functionId: this.model.iid}).then((rec) => {\r\n            //console.log(JSON.stringify(rec))\r\n            this.dataSourceUnit = rec.result.unitList;\r\n            this.ipaginationUnit.total = rec.result.unitList.length;\r\n            this.dataSourceView = rec.result.viewList;\r\n            this.ipaginationView.total = rec.result.viewList.length;\r\n            this.procButtonOpinion = rec.result.busProcSet\r\n\r\n            //如果没有流程，则显示没有流程的按钮\r\n            if (this.model.iisProc == 0) {\r\n              this.showFlag = false;\r\n              this.showFlag2 = true;\r\n              //console.log(\"++++++++\"+JSON.stringify(this.model))\r\n              if (rec.result.procButton != undefined) {\r\n                this.nameButton2 = rec.result.procButton.sbuttonSetName;\r\n              }\r\n            }\r\n            //如果有流程的话，就将数据\r\n            else if (this.model.iisProc == 1) {\r\n              this.showFlag = true;\r\n              this.showFlag2 = false;\r\n              if (rec.result.procKey != undefined) {\r\n                this.nameProc = rec.result.procKey[0];\r\n              }\r\n              if (rec.result.procOpinion != undefined) {\r\n                this.nameOpinion = rec.result.procOpinion.sprocOpinionName;\r\n              }\r\n              if (rec.result.procButton != undefined) {\r\n                this.nameButton = rec.result.procButton.sbuttonSetName;\r\n              }\r\n            } else {\r\n              this.showFlag = false;\r\n              this.showFlag2 = false;\r\n            }\r\n          })\r\n        }\r\n\r\n      },\r\n      close() {\r\n\r\n        this.deptObj = {};\r\n        this.roleObj = {};\r\n        this.procButtonOpinion = {};\r\n        this.showFlag = false;\r\n        this.showFlag2 = false;\r\n        this.dataSourceUnit = [];\r\n        this.dataSourceView = [];\r\n        this.ipaginationUnit = {},\r\n        this.ipaginationView = {},\r\n        this.$emit('close');\r\n        //this.reload();\r\n        this.visible = false;\r\n      },\r\n      selPage() {\r\n        this.$refs.selectPageModel.show()\r\n      },\r\n\r\n      //选择页面\r\n      selectPageOk(data) {\r\n        this.model.ipageId = data[0];\r\n        this.$nextTick(() => {\r\n          this.form.setFieldsValue(pick(this.model, 'ipageId'))\r\n        });\r\n\r\n      },\r\n      handleOk() {\r\n        const that = this;\r\n        // 触发表单验证\r\n        this.form.validateFields((err, values) => {\r\n\r\n          if (!err) {\r\n            console.log(\"in  \" + values);\r\n            that.confirmLoading = true;\r\n            that.confirmLoading = true;\r\n            let httpurl = '';\r\n            let method = '';\r\n            if (!this.model.iid) {\r\n              httpurl += this.url.add;\r\n              method = 'post';\r\n            } else {\r\n              httpurl += this.url.edit;\r\n              method = 'put';\r\n            }\r\n            /*let httpurl = '/oaBus/busFunction/add';\r\n            let method = 'post';*/\r\n            let orderMainData = Object.assign(this.model, values);\r\n            console.log(\"orderMainData \" + orderMainData);\r\n\r\n            /*  if(JSON.stringify(this.deptObj) == \"{}\" ){\r\n\r\n              }*/\r\n            let formData = {\r\n              ...orderMainData,\r\n              busFunctionUnit: this.dataSourceUnit,\r\n              busFunctionView: this.dataSourceView,\r\n              busProcSet: this.procButtonOpinion\r\n            }\r\n\r\n            console.log(formData)\r\n            httpAction(httpurl, formData, method).then((res) => {\r\n              if (res.success) {\r\n                that.$message.success(res.message);\r\n                that.$emit('ok');\r\n              } else {\r\n                that.$message.warning(res.message);\r\n              }\r\n            }).finally(() => {\r\n              that.confirmLoading = false;\r\n              that.close();\r\n            })\r\n\r\n          }\r\n        })\r\n      },\r\n      handleCancel() {\r\n        this.close()\r\n      },\r\n      //得到model和page的数据列，填充对应的下拉选\r\n      getSelection() {\r\n        let url = \"/oaBus/busModel/modelList\";\r\n        getAction(url).then((res) => {\r\n          /*map.put(\"modelList\",paperList);\r\n          map.put(\"pageList\",busPageList);*/\r\n          this.selectModelData = res.result.modelList;\r\n          this.dbtable = res.result.pageList;\r\n        })\r\n      }\r\n\r\n    }\r\n  }\r\n</script>\r\n\r\n<style scoped lang=\"less\">\r\n  .returnBox {\r\n    margin: 0 auto;\r\n    width: 75%;\r\n    margin-top: 20px;\r\n    margin-bottom: 30px;\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: flex-start;\r\n    justify-content: space-between;\r\n    border: 1px solid #dddddd;\r\n    padding: 10px;\r\n\r\n    div {\r\n      width: 300px;\r\n      margin-top: 10px;\r\n    }\r\n\r\n  }\r\n\r\n  .ant-btn {\r\n    padding: 0 5px;\r\n    margin-left: 3px;\r\n  }\r\n\r\n  .ant-form-item-control {\r\n    line-height: 0px;\r\n  }\r\n\r\n  /** 主表单行间距 */\r\n  .ant-form .ant-form-item {\r\n    margin-bottom: 10px;\r\n  }\r\n\r\n  /** Tab页面行间距 */\r\n  .ant-tabs-content .ant-form-item {\r\n    margin-bottom: 0px;\r\n  }\r\n</style>"]}]}