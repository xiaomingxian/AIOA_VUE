{"remainingRequest":"C:\\xxm\\work\\jd\\fore\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\xxm\\work\\jd\\fore\\src\\views\\buttons\\selectUnitName.vue?vue&type=script&lang=js&","dependencies":[{"path":"C:\\xxm\\work\\jd\\fore\\src\\views\\buttons\\selectUnitName.vue","mtime":1579166497080},{"path":"C:\\xxm\\work\\jd\\fore\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1570779194464},{"path":"C:\\xxm\\work\\jd\\fore\\node_modules\\babel-loader\\lib\\index.js","mtime":1570779245522},{"path":"C:\\xxm\\work\\jd\\fore\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1570779194464},{"path":"C:\\xxm\\work\\jd\\fore\\node_modules\\vue-loader\\lib\\index.js","mtime":1570779225726}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\n\nimport {getAction, postAction} from \"@/api/manage\";\nimport {JeecgListMixin} from '@/mixins/JeecgListMixin'\n\nexport default {\n  name: \"selectUnitName\",\n  data() {\n    return {\n      columns: [\n        {\n          title: '县行',\n          dataIndex: 'depart_name',\n          width: 300,\n          align: \"center\",\n        }],\n      busData: [],\n      userData: [],\n      selectedRowKeys: [],\n      selectionRows: [],\n      mockData1: [],\n      usersAndTable: [],\n      visible: false,\n      url: {\n        queryDownUnits: '/oaBus/dynamic/queryUnitsByUser',\n        downSendFile: '/oaBus/dynamic/downSendFile',\n        updateBusdata: '/oaBus/dynamic/update',\n        updateData: '/oaBus/dynamic/updateData', //普通修改数据\n        insertPermit: '/oaBus/dynamic/insertPermit', //普通修改数据\n        copyFile: '/oaBus/oaFile/copyFile' //复制附件\n      }\n    }\n  },\n  methods: {\n\n    show(data) {\n      // console.log(data)\n      this.busData = data;\n      this.initData();\n      this.visible = true;\n    },\n    //初始化数据，查出部门名称对应的数据字典数据\n    initData() {\n      let url = this.url.queryDownUnits;\n      postAction(url).then((rec) => {\n        this.mockData1 = rec.result;\n      })\n    },\n    onSelectChange(selectedRowKeys, selectionRows) {\n      this.selectedRowKeys = selectedRowKeys;\n      this.selectionRows = selectionRows;\n    },\n    handleOk() {\n      let departs = [];\n      let obj = this.selectionRows;\n      if (obj.length <= 0) {\n        alert(\"请选择下发县行\")\n        return;\n      }\n      //组装县行id\n      for (let i in obj) {\n        departs.push(obj[i].id)\n      }\n      var map = {};\n      map['unit'] = departs;\n      //查询县行角色管理员用户\n      let flag = false;\n      postAction(this.url.downSendFile, map).then((res) => {\n        if (res.success) {\n\n          let unitData = res.result[\"unitTables\"];\n          this.userData = res.result;\n          //遍历县行\n          for (let i in unitData) {\n            let param = {};\n            param.modelId = unitData[i].modelId;\n            param.functionId = unitData[i].functionId;\n            let unitId = unitData[i].unitId;\n            //新建任务\n            postAction(\"/oaBus/oaBusdata/queryNewTaskMsg\", param).then(res => {\n              if (res.success) {\n                /**\n                 * 收文页面数据\n                 * s_title 标题\n                 * s_create_name  登记人员\n                 * d_create_time 收文日期\n                 * d_datetime1 成文日期\n                 * s_file_num 文件字号\n                 * s_varchar4 来文文种\n                 * s_receive_num 来文字号\n                 * s_varchar5  来文机关\n                 */\n                let receiveData = {};\n                receiveData.s_title = this.busData.s_title  //标题\n                receiveData.d_sealdate = this.busData.d_sealdate//成文日期  d_sealdate\n                receiveData.s_receive_num = this.busData.s_file_num //来文字号 s_file_num\n                receiveData.s_varchar5 = this.busData.s_unit_name//来文机关 s_unit_name\n                receiveData.i_urgency = this.busData.i_urgency; //缓急 i_urgency\n                receiveData.i_bigint1 = this.busData.i_bigint1  //印发份数\n                receiveData.i_bigint2 = this.busData.i_bigint2  //正文页数\n                receiveData.table = res.result.tableName\n                receiveData.i_id = res.result.busdataId\n                receiveData.s_create_by = \"\";\n                let user = this.userData[unitId];\n                for (let j = 0; j < user.length; j++) {\n                  receiveData.s_create_by += user[j].userId + \",\"; //创建人\n                }\n                //更新数据\n                postAction(this.url.updateData, receiveData).then(res => {\n                  if (res.success) {\n                    //开启流程\n                    postAction(this.url.updateBusdata, {updateBusdata: res.result}).then(res => {\n                      if (res.success) {\n                        for (var key in this.userData) {\n                          if (key == unitId) {\n                            let users = [];\n                            users = this.userData[key];\n                            postAction(this.url.insertPermit, {\n                              list: users,\n                              functionId: param.functionId,\n                              iBusdataId: receiveData.i_id,\n                              table: receiveData.table\n                            }).then(res => {\n                              if (res.success){\n                                //复制发文附件\n                                let fileParam = {};\n                                fileParam.sTable = this.busData.table; //发文业务表\n                                fileParam.iTableId = this.busData.i_id; //发文业务数据id\n                                fileParam.sFileType = 4; //附件类型\n                                fileParam.receiveTable = receiveData.table;\n                                fileParam.receiveId = receiveData.i_id\n                                postAction(this.url.copyFile,fileParam).then(res => {\n                                  if (res.success) {\n                                    if (i == unitData.length-1){\n                                      flag = true;\n                                      this.$message.success(\"下发成功！\")\n                                    }\n                                  } else {\n                                    this.$message.error(\"附件复制失败！\")\n                                  }\n                                })\n                              }else {\n                                this.$message.error(\"用户权限写入失败！\")\n                              }\n                            })\n                          }\n                        }\n                      } else {\n                        this.$message.error(\"开启流程失败！\")\n                      }\n                    })\n\n                  } else {\n                    this.$message.error(\"业务数据更新失败！\")\n                  }\n\n                })\n              } else {\n                this.$message.error(\"新建任务失败！\")\n              }\n            })\n          }\n          this.close()\n        } else {\n          this.$message.error(\"查询角色管理员失败！\")\n        }\n      })\n    },\n    close() {\n      this.$emit('close');\n      this.visible = false;\n      this.selectionRows = [];\n      this.selectedRowKeys = [];\n    },\n\n    handleCancel() {\n      this.close();\n    },\n\n  },\n}\n",{"version":3,"sources":["selectUnitName.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAwBA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA","file":"selectUnitName.vue","sourceRoot":"src/views/buttons","sourcesContent":["<template>\r\n  <a-modal\r\n    :title=\"title\"\r\n    :width=\"710\"\r\n    :height=\"450\"\r\n    :visible=\"visible\"\r\n    @ok=\"handleOk\"\r\n    @cancel=\"handleCancel\"\r\n    cancelText=\"关闭\">\r\n    <!--<p class=\"title\"><span>{{item.depart_name}}</span></p>-->\r\n    <a-table ref=\"table\"\r\n             size=\"middle\"\r\n             bordered\r\n             :columns=\"columns\"\r\n             :dataSource=\"mockData1\"\r\n             :pagination=\"false\"\r\n             :rowSelection=\"{selectedRowKeys: selectedRowKeys, onChange: onSelectChange}\"\r\n    >\r\n    </a-table>\r\n\r\n  </a-modal>\r\n</template>\r\n<script>\r\n\r\n  import {getAction, postAction} from \"@/api/manage\";\r\n  import {JeecgListMixin} from '@/mixins/JeecgListMixin'\r\n\r\n  export default {\r\n    name: \"selectUnitName\",\r\n    data() {\r\n      return {\r\n        columns: [\r\n          {\r\n            title: '县行',\r\n            dataIndex: 'depart_name',\r\n            width: 300,\r\n            align: \"center\",\r\n          }],\r\n        busData: [],\r\n        userData: [],\r\n        selectedRowKeys: [],\r\n        selectionRows: [],\r\n        mockData1: [],\r\n        usersAndTable: [],\r\n        visible: false,\r\n        url: {\r\n          queryDownUnits: '/oaBus/dynamic/queryUnitsByUser',\r\n          downSendFile: '/oaBus/dynamic/downSendFile',\r\n          updateBusdata: '/oaBus/dynamic/update',\r\n          updateData: '/oaBus/dynamic/updateData', //普通修改数据\r\n          insertPermit: '/oaBus/dynamic/insertPermit', //普通修改数据\r\n          copyFile: '/oaBus/oaFile/copyFile' //复制附件\r\n        }\r\n      }\r\n    },\r\n    methods: {\r\n\r\n      show(data) {\r\n        // console.log(data)\r\n        this.busData = data;\r\n        this.initData();\r\n        this.visible = true;\r\n      },\r\n      //初始化数据，查出部门名称对应的数据字典数据\r\n      initData() {\r\n        let url = this.url.queryDownUnits;\r\n        postAction(url).then((rec) => {\r\n          this.mockData1 = rec.result;\r\n        })\r\n      },\r\n      onSelectChange(selectedRowKeys, selectionRows) {\r\n        this.selectedRowKeys = selectedRowKeys;\r\n        this.selectionRows = selectionRows;\r\n      },\r\n      handleOk() {\r\n        let departs = [];\r\n        let obj = this.selectionRows;\r\n        if (obj.length <= 0) {\r\n          alert(\"请选择下发县行\")\r\n          return;\r\n        }\r\n        //组装县行id\r\n        for (let i in obj) {\r\n          departs.push(obj[i].id)\r\n        }\r\n        var map = {};\r\n        map['unit'] = departs;\r\n        //查询县行角色管理员用户\r\n        let flag = false;\r\n        postAction(this.url.downSendFile, map).then((res) => {\r\n          if (res.success) {\r\n\r\n            let unitData = res.result[\"unitTables\"];\r\n            this.userData = res.result;\r\n            //遍历县行\r\n            for (let i in unitData) {\r\n              let param = {};\r\n              param.modelId = unitData[i].modelId;\r\n              param.functionId = unitData[i].functionId;\r\n              let unitId = unitData[i].unitId;\r\n              //新建任务\r\n              postAction(\"/oaBus/oaBusdata/queryNewTaskMsg\", param).then(res => {\r\n                if (res.success) {\r\n                  /**\r\n                   * 收文页面数据\r\n                   * s_title 标题\r\n                   * s_create_name  登记人员\r\n                   * d_create_time 收文日期\r\n                   * d_datetime1 成文日期\r\n                   * s_file_num 文件字号\r\n                   * s_varchar4 来文文种\r\n                   * s_receive_num 来文字号\r\n                   * s_varchar5  来文机关\r\n                   */\r\n                  let receiveData = {};\r\n                  receiveData.s_title = this.busData.s_title  //标题\r\n                  receiveData.d_sealdate = this.busData.d_sealdate//成文日期  d_sealdate\r\n                  receiveData.s_receive_num = this.busData.s_file_num //来文字号 s_file_num\r\n                  receiveData.s_varchar5 = this.busData.s_unit_name//来文机关 s_unit_name\r\n                  receiveData.i_urgency = this.busData.i_urgency; //缓急 i_urgency\r\n                  receiveData.i_bigint1 = this.busData.i_bigint1  //印发份数\r\n                  receiveData.i_bigint2 = this.busData.i_bigint2  //正文页数\r\n                  receiveData.table = res.result.tableName\r\n                  receiveData.i_id = res.result.busdataId\r\n                  receiveData.s_create_by = \"\";\r\n                  let user = this.userData[unitId];\r\n                  for (let j = 0; j < user.length; j++) {\r\n                    receiveData.s_create_by += user[j].userId + \",\"; //创建人\r\n                  }\r\n                  //更新数据\r\n                  postAction(this.url.updateData, receiveData).then(res => {\r\n                    if (res.success) {\r\n                      //开启流程\r\n                      postAction(this.url.updateBusdata, {updateBusdata: res.result}).then(res => {\r\n                        if (res.success) {\r\n                          for (var key in this.userData) {\r\n                            if (key == unitId) {\r\n                              let users = [];\r\n                              users = this.userData[key];\r\n                              postAction(this.url.insertPermit, {\r\n                                list: users,\r\n                                functionId: param.functionId,\r\n                                iBusdataId: receiveData.i_id,\r\n                                table: receiveData.table\r\n                              }).then(res => {\r\n                                if (res.success){\r\n                                  //复制发文附件\r\n                                  let fileParam = {};\r\n                                  fileParam.sTable = this.busData.table; //发文业务表\r\n                                  fileParam.iTableId = this.busData.i_id; //发文业务数据id\r\n                                  fileParam.sFileType = 4; //附件类型\r\n                                  fileParam.receiveTable = receiveData.table;\r\n                                  fileParam.receiveId = receiveData.i_id\r\n                                  postAction(this.url.copyFile,fileParam).then(res => {\r\n                                    if (res.success) {\r\n                                      if (i == unitData.length-1){\r\n                                        flag = true;\r\n                                        this.$message.success(\"下发成功！\")\r\n                                      }\r\n                                    } else {\r\n                                      this.$message.error(\"附件复制失败！\")\r\n                                    }\r\n                                  })\r\n                                }else {\r\n                                  this.$message.error(\"用户权限写入失败！\")\r\n                                }\r\n                              })\r\n                            }\r\n                          }\r\n                        } else {\r\n                          this.$message.error(\"开启流程失败！\")\r\n                        }\r\n                      })\r\n\r\n                    } else {\r\n                      this.$message.error(\"业务数据更新失败！\")\r\n                    }\r\n\r\n                  })\r\n                } else {\r\n                  this.$message.error(\"新建任务失败！\")\r\n                }\r\n              })\r\n            }\r\n            this.close()\r\n          } else {\r\n            this.$message.error(\"查询角色管理员失败！\")\r\n          }\r\n        })\r\n      },\r\n      close() {\r\n        this.$emit('close');\r\n        this.visible = false;\r\n        this.selectionRows = [];\r\n        this.selectedRowKeys = [];\r\n      },\r\n\r\n      handleCancel() {\r\n        this.close();\r\n      },\r\n\r\n    },\r\n  }\r\n</script>\r\n\r\n\r\n\r\n\r\n"]}]}